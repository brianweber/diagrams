<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><title>OAuth 2.x and OpenID Connect sequence diagrams - /dev/posts/</title><meta name=viewport content="initial-scale=1.0, width=device-width"><link href=/ rel=home><link rel=stylesheet href=/css/main.css><link href=/webmention rel=webmention><script src=/js/main.js></script></head> <body> <header> <a href=/ >/dev/posts/</a><span class=mood></span> </header> <nav aria-label="Main navigation"> <ul> <li><a href=/ >Home</a></li> <li><a href=/tags/ >Tags</a></li> <li><a href=/archives/ >Archives</a></li> <li><a href=/vulnerabilities/ >Vulnerabilities</a></li> <li><a href=https://github.com/randomstuff>Code</a></li> <li><button class="link toggleTheme" onclick=toggleTheme();> Change theme</button> </li> </ul> </nav> <aside class=flags> <a class=russia lang=ru href=https://twitter.com/schwarzenegger/status/1504426844199669762>–ù–ï–¢ –í–û–ô–ù–ï</a> <a class=ukraine lang=ua href=https://www.president.gov.ua/en/news/zvernennya-prezidenta-volodimira-zelenskogo-do-ukrayinciv-i-73777>–°–ª–∞–≤–∞ –£–∫—Ä–∞—ó–Ω—ñ</a> </aside> <main id=page-main-content> <article> <header> <h1>OAuth 2.x and OpenID Connect sequence diagrams</h1> <p> <time>Feb 6 2023</time> </p> </header> <nav arial-label="Post links"> <p class=social role=group aria-label="Social features"> <a href="mailto:gabriel AT urdhr DOT fr?subject=Comment for https://www.gabriel.urdhr.fr/2023/02/06/oauth2-diagrams/" class=comment-button aria-label="Sed a comment for this post"> <span role=img aria-hidden=true>ü§î</span> Comment </a> <a href="mailto:gabriel AT urdhr DOT fr?subject=Like for https://www.gabriel.urdhr.fr/2023/02/06/oauth2-diagrams/" class=like-button aria-label="Send a like for this post"> <span role=img aria-hidden=true>üëç</span> Like </a> <a href="mailto:gabriel AT urdhr DOT fr?subject=Like for https://www.gabriel.urdhr.fr/2023/02/06/oauth2-diagrams/" class=dislike-button aria-label="Send a dislike for this post"> <span role=img aria-hidden=true>üëé</span> Dislike </a> <a href="mailto:gabriel AT urdhr DOT fr?subject=[INSERT REACTION HERE] for https://www.gabriel.urdhr.fr/2023/02/06/oauth2-diagrams/" class=reaction-button aria-label="Send another reaction for this post"> <span role=img aria-hidden=true></span>ü§ñ Other reaction </a> <a href="mailto:?subject=Shared OAuth%202.x%20and%20OpenID%20Connect%20sequence%20diagrams&body=https://www.gabriel.urdhr.fr/2023/02/06/oauth2-diagrams/" class=share-button aria-label="Share this post"> <span role=img aria-hidden=true>üéÅ</span> Share </a> </p> <p class=taglist role=group aria-label="Post tags"> <a href=/tags/computer/ rel=tag>computer</a> <a href=/tags/protocol/ rel=tag>protocol</a> <a href=/tags/web/ rel=tag>web</a> <a href=/tags/security/ rel=tag>security</a> <a href=/tags/oauth/ rel=tag>oauth</a> <a href=/tags/openid-connect/ rel=tag>openid-connect</a> </p> </nav> <p>Some sequence diagrams about OAuth 2.x and OpenID Connect.</p> <p>Some sequence diagrams of OAuth 2.X and OpenID Connect. They provide an overview/summary/roadmap of several OAuth and OpenID Connect (OIDC) specifications. Look at the <a href=#references>specifications and other references</a> for details.</p> <h2 id=table-of-content>Table Of Content</h2> <div class=toc> <ul> <li><a href=#table-of-content>Table Of Content</a></li> <li><a href=#oauth>OAuth</a><ul> <li><a href=#authorization-code-flow>Authorization Code Flow</a></li> <li><a href=#token-usage>Token Usage</a></li> <li><a href=#oauth-metadata-and-registration>OAuth Metadata and Registration</a></li> <li><a href=#oauth-discovery>OAuth Discovery</a></li> <li><a href=#other-oauth-flows>Other OAuth Flows</a></li> <li><a href=#authorization-request-protection>Authorization request protection</a></li> </ul> </li> <li><a href=#openid-connect>OpenID Connect</a><ul> <li><a href=#authorization-code-flow_1>Authorization Code Flow</a></li> <li><a href=#other-openid-connect-flows>Other OpenID connect flows</a></li> <li><a href=#openid-connect-discovery-and-registration>OpenID Connect Discovery and Registration</a></li> <li><a href=#third-party-inititated-login>Third-party Inititated Login</a></li> <li><a href=#session-management>Session Management</a></li> <li><a href=#logout>Logout</a></li> <li><a href=#ciba>CIBA</a></li> </ul> </li> <li><a href=#bound-tokens>Bound Tokens</a></li> <li><a href=#appendix-token-summary>Appendix, Token Summary</a></li> <li><a href=#appendix-testing-openid-connect-using-keycloak>Appendix, Testing OpenID Connect using Keycloak</a></li> <li><a href=#references>References</a></li> </ul> </div> <h2 id=oauth>OAuth</h2> <table> <thead> <tr> <th>Flow</th> <th>Initial Request</th> </tr> </thead> <tbody> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-4.1>Authorization code flow</a></td> <td>frontchannel GET/POST authorization_endpoint (response_type=code)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-4.2>Implicit flow</a></td> <td>frontchannel GET/POST authorization_endpoint (response_type=token)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc8628>Device flow</a></td> <td>backchannel POST device_authorization_endpoint</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-4.4>Client credential flow</a></td> <td>backchannel POST token_endpoint (grant_type=client_credentials)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-4.3>Resource Owner password grant</a></td> <td>backchannel POST token_endpoint (grant_type=password)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc7521#section-4.1>Assertion authorization grants</a></td> <td>backchannel POST token_endpoint (grant_type=some assertion type)</td> </tr> </tbody> </table> <figure id=figure-oauth2-overview> <img src=https://www.gabriel.urdhr.fr/img/oauth2-overview.svg style="width: 95%;"> <figcaption> OAuth 2.0 overview (using the authorization code flow with <span style=color:green;>PKCE</span>) </figcaption> </figure> <h3 id=authorization-code-flow>Authorization Code Flow</h3> <figure id=figure-oauth2-code-simplified> <img src=https://www.gabriel.urdhr.fr/img/oauth2-code-simplified.svg style="width: 95%;"> <figcaption> OAuth Authorization Code Flow, simplified diagram </figcaption> <p>In this diagram, the user and user agent are not represented explicitly.</p> </figure> <figure id=figure-oauth2-code> <img src=https://www.gabriel.urdhr.fr/img/oauth2-code.svg style="width: 95%;"> <figcaption> OAuth Authorization Code Flow </figcaption> </figure> <div class="admonition warning" role=note> <p class=admonition-title role=heading>Warning: user-agent for authorization server frontend code</p> <p>Native client applications, should use an external user-agent for the authorization server frontend code i.e. either a standalone browser or an <strong>in-app browser tab</strong>. (such as <a href=https://developer.chrome.com/docs/android/custom-tabs/ >Android Custom Tab</a>, iOS <a href=https://developer.apple.com/documentation/authenticationservices/aswebauthenticationsession>ASWebAuthenticationSession</a> or <a href=https://github.com/google/cordova-plugin-browsertab>cordova-plugin-browsertab</a>).</p> <p>It should <strong>not</strong> use an embedded / <strong>in-app browser</strong> to execute the authorization server frontend logic (WebView, <a href=https://ionicframework.com/docs/native/in-app-browser>Cordova InAppBrowser</a>).</p> <p>In-app browser executes the authorization server frontend code in the system/user browser while the in-app browser tab executes the authorization server frontend code in the client application. In the first case, the user credentials are isolated from the client application.</p> </div> <p>Some extensions:</p> <ul> <li><a href=https://oauth.net/2/pkce/ >Proof Key for Code Exchange</a> (PKCE);</li> <li><a href=https://www.rfc-editor.org/rfc/rfc9207>Authorization Server Issuer Identification</a>;</li> <li><a href=https://www.rfc-editor.org/rfc/rfc8707>Resource Indicators for OAuth 2.0</a>;</li> <li><a href=https://www.ietf.org/archive/id/draft-ietf-oauth-rar-22.html>Rich Authorization Requests</a> (draft).</li> </ul> <h3 id=token-usage>Token Usage</h3> <figure id=figure-oauth2-bearer-token> <img src=https://www.gabriel.urdhr.fr/img/oauth2-bearer-token.svg style="width: 95%;"> <figcaption> Authenticated request with a <a href=https://www.rfc-editor.org/rfc/rfc6750>bearer access token</a> </figcaption> <p>Using a bearer access token for accessing a protected resource.</p> </figure> <figure id=figure-oauth2-refresh-token> <img src=https://www.gabriel.urdhr.fr/img/oauth2-refresh-token.svg style="width: 95%;"> <figcaption> <a href=https://oauth.net/2/refresh-tokens/ >Refresh token</a> </figcaption> <p>Refresh tokens are used by the client to obtain fresh access tokens from the authorization server.</p> </figure> <figure id=figure-oauth2-token-introspection> <img src=https://www.gabriel.urdhr.fr/img/oauth2-token-introspection.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc7662>Token Introspection</a> </figcaption> <p>Let the resource server get information about an access token</p> </figure> <figure id=figure-oauth2-token-revocation> <img src=https://www.gabriel.urdhr.fr/img/oauth2-token-revocation.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc7009>Token Revocation</a> </figcaption> <p>Let the client revoke a refresh token or an access token</p> </figure> <h3 id=oauth-metadata-and-registration>OAuth Metadata and Registration</h3> <figure id=figure-oauth2-server-metadata> <img src=https://www.gabriel.urdhr.fr/img/oauth2-server-metadata.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc8414>Server metadata</a> </figcaption> <p>Getting the configuration/features of an authorization server</p> </figure> <figure id=figure-oauth2-client-registration> <img src=https://www.gabriel.urdhr.fr/img/oauth2-client-registration.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc7591>Dynamic client registration</a> and <a href=https://www.rfc-editor.org/rfc/rfc7592>dynamic client registration management</a> </figcaption> <p> Automated registration of a client on the authorization server and updating the client registration </p> </figure> <h3 id=oauth-discovery>OAuth Discovery</h3> <figure id=figure-oauth2-as-discovery> <img src=https://www.gabriel.urdhr.fr/img/oauth2-as-discovery.svg style="width: 95%;"> <figcaption> <a href=https://www.ietf.org/archive/id/draft-parecki-oauth-authorization-server-discovery-00.html>Authorization server discovery</a> (draft) </figcaption> <p>Let the client application discover the authorization server to be used for a resource server</p> </figure> <figure id=figure-oauth2-client-discovery> <img src=https://www.gabriel.urdhr.fr/img/oauth2-client-discovery.svg style="width: 95%;"> <figcaption> <a href=https://www.ietf.org/archive/id/draft-looker-oauth-client-discovery-01.html>Client discovery</a> </figcaption> <p>Let the authorization server discover the client instead of registering the client</p> </figure> <h3 id=other-oauth-flows>Other OAuth Flows</h3> <figure id=figure-oauth2-implicit> <img src=https://www.gabriel.urdhr.fr/img/oauth2-implicit.svg style="width: 95%;"> <figcaption> OAuth <a href=https://oauth.net/2/grant-types/implicit/ >implicit flow</a> </figcaption> <p>This is a (legacy) flow which was intended to be used for non-confidential clients but is now replaced with the authorization code flow with <a href=https://oauth.net/2/pkce/ >Proof Key for Code Exchange</a> (PKCE) which is more secure. </p> </figure> <div class="admonition note" role=note> <p class=admonition-title role=heading>Note: lack of support for refresh tokens for some flows</p> <p>Refresh tokens are NOT supported for the implicit<sup id=fnref:implicit-no-refresh><a class=footnote-ref href=#fn:implicit-no-refresh aria-label="(see note 2)">2</a></sup> flow and for the client credentials flow.</p> </div> <figure id=figure-oauth2-password> <p><img src=https://www.gabriel.urdhr.fr/img/oauth2-password.svg style="width: 95%;"></p> <figcaption> OAuth <a href=https://oauth.net/2/grant-types/password/ >resource owner crecentials grant</a> (aka password grant) </figcaption> <p>Legacy flow, very insecure<sup id=fnref:security-password-flow><a class=footnote-ref href=#fn:security-password-flow aria-label="(see note 1)">1</a></sup> where the user provides his/her password to the application.</p> </figure> <figure id=figure-oauth2-device> <img src=https://www.gabriel.urdhr.fr/img/oauth2-device.svg style="width: 95%;"> <figcaption> OAuth <a href=https://oauth.net/2/device-flow/ >device flow</a> </figcaption> <p>Used for provisioning an access token to device which cannot execute a browser or have limited interactivity</p> </figure> <figure id=figure-oauth2-client> <img src=https://www.gabriel.urdhr.fr/img/oauth2-client.svg style="width: 95%;"> <figcaption> OAuth <a href=https://oauth.net/2/grant-types/client-credentials/ >client credentials flow</a> </figcaption> <p>Used by the client (i.e. application) in order to obtain tokens for itself</p> </figure> <p>Not represented here:</p> <ul> <li><a href=https://www.rfc-editor.org/rfc/rfc7521#section-4.1>Assertions as authorization grants</a> i.e. submiting an assertion (eg. SAML, JWT) as part of the authorization request for user authentication.</li> <li><a href=https://www.rfc-editor.org/rfc/rfc8693>Token exchange grant</a></li> </ul> <h3 id=authorization-request-protection>Authorization request protection</h3> <p>The following approaches may be used (or combined) to protect the privacy and/or integrity of the authorization request.</p> <figure id=figure-oauth2-jar> <img src=https://www.gabriel.urdhr.fr/img/oauth2-jar.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc9101>JWT-Secured Authorization Request</a> (JAR) </figcaption> <p>The authorization request is a JWT which can be signed or signed-then-encrypted.</p> </figure> <figure id=figure-oauth2-par> <img src=https://www.gabriel.urdhr.fr/img/oauth2-par.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc9126>Pushed Authorization Requests</a> (PAR) </figcaption> <p>With Pushed Authorization Requests, the client sends the authorization request directly to the authorization server (backchannel) instead of sending it through the user agent (frontchannel). This prevents the user from having access to and tempering with the authorization request. </p> </figure> <h2 id=openid-connect>OpenID Connect</h2> <table> <thead> <tr> <th>Flow</th> <th>response_type</th> <th>nonce</th> <th>c_hash</th> <th>at_hash</th> <th>...rt_hash</th> </tr> </thead> <tbody> <tr> <td>Authorization code flow</td> <td>code</td> <td>OPTIONAL</td> <td>OPTIONAL</td> <td>OPTIONAL</td> <td>N/A</td> </tr> <tr> <td>Implicit flow</td> <td>id_token token</td> <td>REQUIRED</td> <td>OPTIONAL</td> <td>REQUIRED</td> <td>N/A</td> </tr> <tr> <td></td> <td>id_token</td> <td>REQUIRED</td> <td>OPTIONAL</td> <td>OPTIONAL</td> <td>N/A</td> </tr> <tr> <td>Hybrid flow</td> <td>code id_token</td> <td>REQUIRED</td> <td>REQUIRED<sup id=fnref3:hash><a class=footnote-ref href=#fn:hash aria-label="(see note 3)">3</a></sup></td> <td>REQUIRED<sup id=fnref4:hash><a class=footnote-ref href=#fn:hash aria-label="(see note 3)">3</a></sup></td> <td>N/A</td> </tr> <tr> <td></td> <td>code token</td> <td>REQUIRED</td> <td>OPTIONAL</td> <td>OPTIONAL</td> <td>N/A</td> </tr> <tr> <td></td> <td>code id_token token</td> <td>REQUIRED</td> <td>REQUIRED<sup id=fnref:hash><a class=footnote-ref href=#fn:hash aria-label="(see note 3)">3</a></sup></td> <td>REQUIRED<sup id=fnref2:hash><a class=footnote-ref href=#fn:hash aria-label="(see note 3)">3</a></sup></td> <td>N/A</td> </tr> <tr> <td>CIBA push mode</td> <td>N/A</td> <td>N/A</td> <td>N/A</td> <td>REQUIRED</td> <td>REQUIRED<sup id=fnref:rt_hash><a class=footnote-ref href=#fn:rt_hash aria-label="(see note 4)">4</a></sup></td> </tr> <tr> <td>CIBA other modes</td> <td>N/A</td> <td>N/A</td> <td>N/A</td> <td>OPTIONAL</td> <td>OPTIONAL</td> </tr> </tbody> </table> <figure id=figure-oidc-overview> <img src=https://www.gabriel.urdhr.fr/img/oidc-overview.svg style="width: 95%;"> <figcaption> OpenID connect overview (using the authorization code flow with <span style=color:green;>PKCE</span>) </figcaption> </figure> <h3 id=authorization-code-flow_1>Authorization Code Flow</h3> <figure id=figure-oidc-code-simplified> <img src=https://www.gabriel.urdhr.fr/img/oidc-code-simplified.svg style="width: 95%;"> <figcaption> OpenID Connect with the Authorization Code Flow, simplified </figcaption> <p>In this diagram, the user and user agent are not represented explicitly.</p> </figure> <figure id=figure-oidc-code> <img src=https://www.gabriel.urdhr.fr/img/oidc-code.svg style="width: 95%;"> <figcaption> OpenID Connect with the Authorization Code Flow </figcaption> </figure> <figure id=figure-oidc-userinfo> <img src=https://www.gabriel.urdhr.fr/img/oidc-userinfo.svg style="width: 95%;"> <figcaption> <a href=https://openid.net/specs/openid-connect-core-1_0.html#UserInfo>UserInfo</a> </figcaption> <p>The acces_token may be used by the client to obtain additional user information.</p> </figure> <h3 id=other-openid-connect-flows>Other OpenID connect flows</h3> <figure id=figure-oidc-implicit> <p><img src=https://www.gabriel.urdhr.fr/img/oidc-implicit.svg style="width: 95%;"></p> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth>implicit</a> flow </figcaption> </figure> <figure id=figure-oidc-implicit> <p><img src=https://www.gabriel.urdhr.fr/img/oidc-implicit.svg style="width: 95%;"></p> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth>hybrid</a> flow. </figcaption> <p>In this flow, an authorization code is returned in the authentication response alongside with the <code>access_token</code> and or <code>id_token</code>.</p> </figure> <div class="admonition note" role=note> <p class=admonition-title role=heading>Note: <code>at_hash</code> and <code>c_hash</code> claims</p> <p>The <a href=https://openid.net/specs/openid-connect-core-1_0.html#CodeIDToken><code>at_hash</code></a> and <a href=https://openid.net/specs/openid-connect-core-1_0.html#HybridIDToken><code>c_hash</code></a> claims contain <a href=https://security.stackexchange.com/questions/34796/truncating-the-output-of-sha256-to-128-bits>half</a> of the hash of the <code>access_token</code> and <code>code</code> respectively. The former is required in both implicit and hybrid flows. The latter is required in the ID token returned by the authorization endpoint in the hybrid flow. They protect against <a href=https://openid.net/specs/openid-connect-core-1_0.html#rfc.section.16.11>access token and authorization code substitution attacks</a> respectively..</p> </div> <h3 id=openid-connect-discovery-and-registration>OpenID Connect Discovery and Registration</h3> <figure id=figure-oidc-config> <img src=https://www.gabriel.urdhr.fr/img/oidc-config.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-discovery-1_0.html>discovery</a> and <a href=https://openid.net/specs/openid-connect-registration-1_0.html>client registration</a> </figcaption> <p>Discovery is based on <a href=https://www.rfc-editor.org/rfc/rfc7033>Webfinger</a></p> </figure> <h3 id=third-party-inititated-login>Third-party Inititated Login</h3> <figure id=figure-oidc-login-third-party> <img src=https://www.gabriel.urdhr.fr/img/oidc-login-third-party.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-core-1_0.html#rfc.section.4>Third-party Inititated Login</a> </figcaption> <p>Front-channel initiation of the login process by the OpenID provider or another party</p> </figure> <h3 id=session-management>Session Management</h3> <figure id=figure-oidc-session> <p><img src=https://www.gabriel.urdhr.fr/img/oidc-session.svg style="width: 95%;"></p> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-session-1_0.html>Session Management</a> </figcaption> <p>This uses a <code>&lt;iframe&gt;</code><sup id=fnref:two-iframes><a class=footnote-ref href=#fn:two-iframes aria-label="(see note 5)">5</a></sup> for direct (front-channel) communication of session state update.</p> </figure> <h3 id=logout>Logout</h3> <figure id=figure-oidc-fc-logout> <img src=https://www.gabriel.urdhr.fr/img/oidc-fc-logout.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-frontchannel-1_0.html>Front-Channel Logout</a> </figcaption> <p>Logout process initiated by the OpenID Provider through the user UA using a <code>&lt;iframe&gt;</code></p> </figure> <figure id=figure-oidc-bc-logout> <img src=https://www.gabriel.urdhr.fr/img/oidc-bc-logout.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-backchannel-1_0.html>Back-Channel Logout</a><a> </a></figcaption> <p>Logout process initiated by the OpenID Provider using a direct (back-channel) request</p> </figure> <figure id=figure-oidc-rpi-logout> <img src=https://www.gabriel.urdhr.fr/img/oidc-rpi-logout.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-connect-rpinitiated-1_0.html>Relying Party Initiated Logout</a> </figcaption> </figure> <h3 id=ciba>CIBA</h3> <figure id=figure-oidc-ciba> <img src=https://www.gabriel.urdhr.fr/img/oidc-ciba.svg style="width: 95%;"> <figcaption> OpenID Connect <a href=https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html>Client-Initiated Backchannel Authentication Flow</a> (CIBA) </figcaption> <p>This is not unlike the device flow but more user firendly.</p> </figure> <h2 id=bound-tokens>Bound Tokens</h2> <figure id=figure-oauth2-mtls-auth> <img src=https://www.gabriel.urdhr.fr/img/oauth2-mtls-auth.svg style="width: 95%;"> <figcaption> <a href=https://www.rfc-editor.org/rfc/rfc8705#name-mutual-tls-for-oauth-client>Client authentication using mutual TLS</a> and <a href=https://www.rfc-editor.org/rfc/rfc8705#name-mutual-tls-for-oauth-client>Certificate-Bound Access Tokens</a> </figcaption> </figure> <figure id=figure-oauth2-dpop> <img src=https://www.gabriel.urdhr.fr/img/oauth2-dpop.svg style="width: 95%;"> <figcaption> <a href=https://www.ietf.org/archive/id/draft-ietf-oauth-dpop-13.html#name-resource-server-provided-no>OAuth 2.0 Demonstrating Proof-of-Possession at the Application Layer (DPoP)</a> (draft) </figcaption> <p>Alternative to Certificate-bound Access Tokens when mTLS is not practical (eg. for Single Page Applications). The idea is the same but demonstration of the possession of a private key is given at the application (HTTP) layer in a <code>DPoP</code> HTTP header.</p> </figure> <h2 id=appendix-token-summary>Appendix, Token Summary</h2> <table> <thead> <tr> <th>Name</th> <th>Flow</th> <th>Content</th> </tr> </thead> <tbody> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-1.3.1>Authorization code</a> (<code>code</code>)</td> <td>AS ‚Üí client ‚Üí AS</td> <td>opaque</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-1.4>Access Token</a> (<code>access_token</code>)</td> <td>AS ‚Üí client ‚Üí RS</td> <td>opaque (<a href=https://www.rfc-editor.org/rfc/rfc9068>may be a JWT</a>, <code>at+jwt</code>)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#section-1.5>Refresh token</a> (<code>refresh_token</code>)</td> <td>AS ‚Üí client ‚Üí AS</td> <td>opaque (sometimes a JWT)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc9101>JWT-Secured Authz. Request (JAR)</a> (<code>request</code>)</td> <td>client ‚Üí AS</td> <td>JWT (<code>oauth-authz-req+jwt</code>)</td> </tr> <tr> <td><a href=https://openid.net/specs/oauth-v2-jarm.html>JWT-Secured Authz. Response Mode (JARM)</a></td> <td>AS ‚Üí client</td> <td>JWT</td> </tr> <tr> <td><a href=https://datatracker.ietf.org/doc/html/draft-ietf-oauth-jwt-introspection-response>JWT response for Token Introspection</a></td> <td>AS ‚Üí RS</td> <td>JWT (<code>token-introspection+jwt</code>)</td> </tr> <tr> <td><a href=https://datatracker.ietf.org/doc/html/draft-ietf-oauth-dpop#name-dpop-proof-jwt-syntax>DPoP Proof-of-possession</a></td> <td>client ‚Üí AS / RS</td> <td>JWT (<code>dpop+jwt</code>)</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc7591#section-2.3>Software Statement</a> (<code>software_statement</code>)</td> <td>client vendor ‚Üí client ‚Üí AS</td> <td>JWT</td> </tr> <tr> <td><a href=https://www.rfc-editor.org/rfc/rfc6749#page-26>Authorization</a> or <a href=https://openid.net/specs/openid-connect-rpinitiated-1_0.html#RPLogout>Logout</a> State</td> <td>client ‚Üí AS ‚Üí client</td> <td>opaque</td> </tr> <tr> <td>PKCE <a href=https://www.rfc-editor.org/rfc/rfc7636#section-4.1>Code Verifier</a> (<code>code_verifier</code>)</td> <td>client ‚Üí AS</td> <td>opaque (random)</td> </tr> <tr> <td>PKCE <a href=https://www.rfc-editor.org/rfc/rfc7636#section-4.2>Code Challenge</a> (<code>code_challenge</code>)</td> <td>client ‚Üí AS</td> <td>hash of the code verifier (base64url)</td> </tr> <tr> <td>OIDC <a href=https://openid.net/specs/openid-connect-core-1_0.html#IDToken>ID token</a> (<code>id_token</code>)</td> <td>OP (AS) ‚Üí client (‚Üí AS)</td> <td>JWT</td> </tr> <tr> <td>OIDC <a href=https://openid.net/specs/openid-connect-core-1_0.html#NonceNotes>Nonce</a></td> <td>client ‚Üí AS ‚Üí client</td> <td>opaque</td> </tr> <tr> <td>OIDC <a href=https://openid.net/specs/openid-connect-frontchannel-1_0.html#OPLogout>Session ID</a></td> <td>AS ‚Üí client</td> <td>opaque</td> </tr> <tr> <td>OIDC <a href=https://openid.net/specs/openid-connect-session-1_0.html#CreatingUpdatingSessions>Session State</a></td> <td>OP (AS) ‚Üí client</td> <td>opaque</td> </tr> <tr> <td><a href=https://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication>OIDC <code>private_key_jwt</code> and <code>client_secret_jwt</code> client authentication</a></td> <td>client ‚Üí OP / AS</td> <td>JWT</td> </tr> </tbody> </table> <h2 id=appendix-testing-openid-connect-using-keycloak>Appendix, Testing OpenID Connect using Keycloak</h2> <p><a href=https://www.keycloak.org/ >Keycloak</a> is an Apache-licensed Identity and Access Management (IAM) software. We can quickly spawn a local instance <a href=https://www.keycloak.org/getting-started/getting-started-docker>in a container</a> in order to experiment with OAuth and OpenID Connect:</p> <div class=codehilite><pre><span></span><code>podman<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>keycloak<span class=w> </span>-p<span class=w> </span><span class=m>127</span>.0.0.1:8080:8080<span class=se>\</span>
<span class=w>    </span>-e<span class=w> </span><span class=nv>KEYCLOAK_ADMIN</span><span class=o>=</span>admin<span class=w> </span><span class=se>\</span>
<span class=w>    </span>-e<span class=w> </span><span class=nv>KEYCLOAK_ADMIN_PASSWORD</span><span class=o>=</span>change_me<span class=w> </span><span class=se>\</span>
<span class=w>    </span>quay.io/keycloak/keycloak:20.0.1<span class=w> </span>start-dev
</code></pre></div> <p>A different port can be used:</p> <div class=codehilite><pre><span></span><code>podman<span class=w> </span>run<span class=w> </span>--name<span class=w> </span>keycloak<span class=w> </span>-p<span class=w> </span><span class=m>127</span>.0.0.1:3000:3000<span class=w> </span><span class=se>\</span>
<span class=w>    </span>-e<span class=w> </span><span class=nv>KEYCLOAK_ADMIN</span><span class=o>=</span>admin<span class=w> </span><span class=se>\</span>
<span class=w>    </span>-e<span class=w> </span><span class=nv>KEYCLOAK_ADMIN_PASSWORD</span><span class=o>=</span>change_me<span class=w> </span><span class=se>\</span>
<span class=w>    </span>quay.io/keycloak/keycloak:20.0.1<span class=w> </span>start-dev<span class=w> </span>--hostname-port<span class=o>=</span><span class=m>3000</span><span class=w> </span>--http-port<span class=o>=</span><span class=m>3000</span>
</code></pre></div> <p>Some interesting Docker/Podman arguments:</p> <ul> <li><code>-v keycloak:/opt/keycloak/data</code></li> </ul> <p>Some interesting KeyCloak arguments:</p> <ul> <li><code>--features=declarative-user-profile,par,token-exchange,ciba,impersonation,step-up-authentication</code>, add <a href=https://www.keycloak.org/server/features>features</a></li> </ul> <p>Interesting endpoints:</p> <ul> <li><code>/admin/</code>, administration user interface (create new users, realms, configure client applications);</li> <li><code>/realms/master/account</code>, user interface to login to the <code>master</code> realm;</li> <li><code>/realms/master/.well-known/openid-configuration</code>, metadata for the <code>master</code> realm.</li> </ul> <p>The Keycloak web site hosts a <a href=https://www.keycloak.org/app/ >simple test OpenID connect client</a> which can be used to test the OIDC provider.</p> <p>See as well:</p> <ul> <li><a href=https://www.keycloak.org/server/containers>Running Keycloak in a container</a></li> </ul> <h2 id=references>References</h2> <p>IANA registries:</p> <ul> <li><a href=https://www.iana.org/assignments/oauth-parameters/oauth-parameters.xhtml>OAuth Parameters (IANA registry)</a></li> <li><a href=https://www.iana.org/assignments/authentication-method-reference-values/authentication-method-reference-values.xhtml>Authentication Method Reference Values (IANA registry)</a></li> <li><a href=https://www.iana.org/assignments/jwt/jwt.xhtml>JWT registry</a></li> </ul> <p>Lists of specifications:</p> <ul> <li><a href=https://openid.net/developers/specs/ >OpenID specifications</a></li> <li><a href=https://oauth.net/2/ >OAuth 2.x specifications</a></li> </ul> <p>Informational:</p> <ul> <li><a href=https://aaronparecki.com/oauth-2-simplified/ >OAuth 2 Simplified</a></li> <li><a href=https://www.scottbrady91.com/oauth/client-authentication>OAuth client authentication - more than just client secrets</a></li> <li><a href=https://connect2id.com/products/nimbus-oauth-openid-connect-sdk/openid-connect-providers>List of public OpenID Connect¬†providers</a></li> <li><a href=https://danielfett.de/2020/05/16/pkce-vs-nonce-equivalent-or-not/ >PKCE vs. Nonce: Equivalent or Not?</a></li> </ul> <p>Examples of Server Metadata:</p> <ul> <li><a href=https://accounts.google.com/.well-known/openid-configuration>Google</a></li> <li><a href=https://auth.bas.psc.esante.gouv.fr/auth/realms/esante-wallet/.well-known/wallet-openid-configuration>Pro Sant√© Connect (sandbox)</a>, based on KeyCloak</li> <li><a href=https://auth.esw.esante.gouv.fr/auth/realms/esante-wallet/.well-known/wallet-openid-configuration>Pro Sant√© Connect</a>, based on KeyCloak</li> <li><a href=https://auth.integ01.dev-franceconnect.fr/api/v2/.well-known/openid-configuration>France connect (integration)</a></li> <li><a href=https://idp.mobileconnectetmoi.fr/auth/realms/mcem/.well-known/openid-configuration>Mobile Connect</a>, based on KeyCloak</li> <li><a href=https://idp.yris.eu/auth/realms/yris/.well-known/openid-configuration>Yris</a>, based on KeyCloak</li> <li><a href=https://www.facebook.com/.well-known/openid-configuration/ >Facebook</a></li> <li><a href=https://login.microsoft.com/microsoft.com/.well-known/openid-configuration>Microsoft ADFS</a>, where <code>microsoft.com</code> is the tenant ID for Mictosoft itself</li> <li><a href=https://appleid.apple.com/.well-known/openid-configuration>AppleID</a></li> <li><a href=https://api.login.yahoo.com/.well-known/openid-configuration>Yahoo</a></li> </ul> <p>Other:</p> <ul> <li><a href=https://sso.tax/ >The SSO Wall of Shame</a></li> <li><a href=https://portswigger.net/research/hidden-oauth-attack-vectors>Hidden OAuth attack vectors</a></li> </ul> <div class=footnote role=group aria-label=Footnotes> <hr> <ol> <li id=fn:security-password-flow> <p>The password flow is very insecure because the user password is given to the OAuth client. Moreover this flow only support password-based user authentication.¬†<a class=footnote-backref href=#fnref:security-password-flow title="Jump back to footnote 1 in the text" aria-label="back to main content">‚Ü©</a></p> </li> <li id=fn:implicit-no-refresh> <p>See <a href=https://stackoverflow.com/questions/34231717/why-in-implicit-grant-flow-the-auth-server-must-not-issue-a-refresh-token>‚ÄúWhy in implicit grant flow , the auth server MUST NOT issue a refresh token‚Äù</a> for why the refresh token is not supported in the implicit flow.¬†<a class=footnote-backref href=#fnref:implicit-no-refresh title="Jump back to footnote 2 in the text" aria-label="back to main content">‚Ü©</a></p> </li> <li id=fn:hash> <p>The <code>c_hash</code> and <code>at_hash</code> claims are REQUIRED in the <code>id_token</code> returned as part of the authentication response (when the corresponding value is present as well). They are OPTIONAL (when relevant) in the <code>id_token</code> returned in the Access Token Response.¬†<a class=footnote-backref href=#fnref:hash title="Jump back to footnote 3 in the text" aria-label="back to main content">‚Ü©</a><a class=footnote-backref href=#fnref2:hash title="Jump back to footnote 3 in the text" aria-label="back to main content">‚Ü©</a><a class=footnote-backref href=#fnref3:hash title="Jump back to footnote 3 in the text" aria-label="back to main content">‚Ü©</a><a class=footnote-backref href=#fnref4:hash title="Jump back to footnote 3 in the text" aria-label="back to main content">‚Ü©</a></p> </li> <li id=fn:rt_hash> <p>If a <code>refresh_token</code> is sent.¬†<a class=footnote-backref href=#fnref:rt_hash title="Jump back to footnote 4 in the text" aria-label="back to main content">‚Ü©</a></p> </li> <li id=fn:two-iframes> <p>The specification mentions two <code>&lt;iframe&gt;</code>. But as far as I understand, the <a href=https://openid.net/specs/openid-connect-session-1_0.html#RPiframe>Relying party <code>&lt;iframe&gt;</code></a> is not stricly absolutely necessary and is only an <a href=https://stackoverflow.com/a/37227472/637866>implementation detail</a>.¬†<a class=footnote-backref href=#fnref:two-iframes title="Jump back to footnote 5 in the text" aria-label="back to main content">‚Ü©</a></p> </li> </ol> </div> </article> </main> <footer> <form action=https://duckduckgo.com/ role=search> <input type=hidden name=sites value=www.gabriel.urdhr.fr> <input type=hidden name=kae value=-1 id=_ddg_theme> <label> Search with DuckDuckGo <input role=searchbox name=q required> </label> <button type=submit>Search</button> </form> <p> <small> <a href=/about/ >About</a> - <a href=/legal/ lang=fr>Mentions l√©gales</a> </small> </p> </footer> </body> </html>